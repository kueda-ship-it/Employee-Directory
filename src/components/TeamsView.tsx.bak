import { useState, useRef, useEffect } from 'react';
import { supabase } from '../lib/supabase';
// Sidebar removed - handled by App.tsx

interface TeamsViewProps {
    selectedTeamId: string;
    teams: { id: string; name: string; icon: string; }[];
    setTeams: React.Dispatch<React.SetStateAction<{ id: string; name: string; icon: string; }[]>>;
}

// Mock users for mention
const MOCK_USERS = [
    { id: 'u1', name: 'K. Ueda', display: 'K. Ueda' },
    { id: 'u2', name: 'Tanaka', display: 'Tanaka Taro' },
    { id: 'u3', name: 'Suzuki', display: 'Suzuki Jiro' },
];

export function TeamsView({ selectedTeamId, teams, setTeams }: TeamsViewProps) {
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [loginId, setLoginId] = useState('');
    const [password, setPassword] = useState('');
    const [currentUser, setCurrentUser] = useState<any>(null);
    // selectedTeam and teams state moved to App.tsx

    // Post input state
    const [postContent, setPostContent] = useState('');
    const [showMentionList, setShowMentionList] = useState(false);
    const [mentionQuery, setMentionQuery] = useState('');
    const [cursorPos, setCursorPos] = useState(0);
    const inputRef = useRef<HTMLInputElement>(null);

    const [messages, setMessages] = useState<any[]>([]);

    // Fetch messages for selected team
    useEffect(() => {
        const fetchMessages = async () => {
            let query = supabase
                .from('messages')
                .select('*, user_id (display_name)')
                .order('created_at', { ascending: false }); // Newest first

            if (selectedTeamId !== 'all') {
                query = query.eq('team_id', selectedTeamId);
            }

            const { data, error } = await query;

            if (error) {
                console.error("Error fetching messages:", error);
            } else if (data) {
                setMessages(data);
            }
        };
        fetchMessages();

        const channelName = selectedTeamId === 'all' ? 'messages:all' : `messages:${selectedTeamId}`;
        const filter = selectedTeamId === 'all' ? undefined : `team_id=eq.${selectedTeamId}`;

        const subscription = supabase
            .channel(channelName)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'messages', filter }, fetchMessages)
            .subscribe();

        return () => { subscription.unsubscribe(); };
    }, [selectedTeamId]);

    const handleLogin = async () => {
        try {
            if (loginId === 'admin' && password === 'admin123') {
                setIsAuthenticated(true);
                setCurrentUser({ id: 'admin', display_name: 'Administrator', role: 'admin' });
                return;
            }

            const email = loginId.includes('@') ? loginId : `${loginId}@example.com`;
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });

            if (data.user) {
                setIsAuthenticated(true);
                setCurrentUser({ id: data.user.id, display_name: loginId, role: 'user' });
            } else if (error) {
                alert('„É≠„Ç∞„Ç§„É≥Â§±Êïó: ' + error.message);
            }
        } catch (err) {
            console.error(err);
            alert('„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
        }
    };

    const handleMicrosoftLogin = () => {
        alert('Microsoft „Çµ„Ç§„É≥„Ç§„É≥„ÅØÊú™ÂÆüË£Ö„Åß„Åô (MSALË®≠ÂÆö„ÅåÂøÖË¶Å)');
    };

    const handleSignup = () => {
        alert('Êñ∞Ë¶èÁôªÈå≤Ê©üËÉΩ„ÅØÊú™ÂÆüË£Ö„Åß„Åô');
    };

    // Mention logic
    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const val = e.target.value;
        setPostContent(val);
        const pos = e.target.selectionStart || 0;
        setCursorPos(pos);

        // Check for @
        const lastAt = val.lastIndexOf('@', pos - 1);
        if (lastAt !== -1) {
            const query = val.slice(lastAt + 1, pos);
            // Simple check: if query has speces, cancel mention unless it matches a name
            if (!query.includes(' ')) {
                setShowMentionList(true);
                setMentionQuery(query);
                return;
            }
        }
        setShowMentionList(false);
    };

    const insertMention = (userName: string) => {
        const lastAt = postContent.lastIndexOf('@', cursorPos - 1);
        const before = postContent.slice(0, lastAt);
        const after = postContent.slice(cursorPos);
        const newContent = `${before}@${userName} ${after}`;
        setPostContent(newContent);
        setShowMentionList(false);
        if (inputRef.current) {
            inputRef.current.focus();
        }
    };

    if (!isAuthenticated) {
        return (
            <div className="flex items-center justify-center min-h-[80vh]">
                <div className="w-full max-w-md bg-[#1F1E1D] rounded-2xl p-8 border border-slate-700">
                    <h2 className="text-2xl font-black text-white text-center mb-8">Contact Team Manager</h2>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-semibold text-slate-300 mb-2">„É¶„Éº„Ç∂„Éº ID / „É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                            <input
                                type="text"
                                className="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                placeholder="example@mail.com „Åæ„Åü„ÅØ 'admin'"
                                value={loginId}
                                onChange={e => setLoginId(e.target.value)}
                                onKeyPress={e => e.key === 'Enter' && handleLogin()}
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-semibold text-slate-300 mb-2">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                            <input
                                type="password"
                                className="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ „Åæ„Åü„ÅØ 'admin123'"
                                value={password}
                                onChange={e => setPassword(e.target.value)}
                                onKeyPress={e => e.key === 'Enter' && handleLogin()}
                            />
                        </div>
                        <div className="space-y-3 pt-4">
                            <button
                                onClick={handleLogin}
                                className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition-colors"
                            >
                                „É≠„Ç∞„Ç§„É≥
                            </button>
                            <div className="text-center text-xs text-slate-400">„Åæ„Åü„ÅØ</div>
                            <button
                                onClick={handleMicrosoftLogin}
                                className="w-full bg-[#2F2F2F] hover:bg-[#3F3F3F] border border-slate-600 text-white font-semibold py-3 rounded-lg transition-colors flex items-center justify-center gap-2"
                            >
                                <svg width="20" height="20" viewBox="0 0 23 23" xmlns="http://www.w3.org/2000/svg">
                                    <path fill="#f35325" d="M0 0h11v11H0z" />
                                    <path fill="#81bc06" d="M12 0h11v11H12z" />
                                    <path fill="#05a6f0" d="M0 12h11v11H0z" />
                                    <path fill="#ffba08" d="M12 12h11v11H12z" />
                                </svg>
                                Microsoft „Åß„Çµ„Ç§„É≥„Ç§„É≥
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    const selectedTeam = teams.find(t => t.id === selectedTeamId);


    const handlePost = async () => {
        if (!postContent.trim() || selectedTeamId === 'all') return;

        // Use current user id if logged in, otherwise null or a demo ID
        const userId = currentUser?.id || null;

        // For demo purposes if not logged in with real auth, maybe handle gracefully or just insert
        // Since we defined user_id FK, we need a valid user or handle it.
        // If strict RLS/FK validation is on, this might fail if not logged in.
        // However, for this playground, let's assume we can insert or specific logic.

        // Actually, let's insert simple text. 
        // If user_id is required by schema, we need it. 
        // The schema: user_id UUID REFERENCES auth.users(id)

        // If we are not truly logged in via Supabase Auth, we can't insert a valid user_id.
        // For "Playground" mode without real auth, we might need to relax schema or use a mock user ID if possible (but auth.users ID is strict).
        // Let's check currentUser. If set via 'admin' mock login, it has 'admin' as ID, which is NOT a valid UUID for auth.users.
        // This will cause FK error.

        // WORKAROUND for Demo:
        // We will try to insert. If it fails due to FK, we'll alert.
        // OR: modifying schema to allow null user_id?
        // Let's try inserting without user_id if mock login.

        const payload: any = {
            team_id: selectedTeamId,
            content: postContent,
            status: 'todo'
        };

        if (currentUser && currentUser.id !== 'admin') {
            payload.user_id = currentUser.id;
        }

        const { error } = await supabase.from('messages').insert([payload]);

        if (error) {
            alert('ÊäïÁ®ø„Ç®„É©„Éº: ' + error.message);
        } else {
            setPostContent('');
        }
    };

    return (
        <div className="h-full relative">
            {/* Main Content Area */}
            <div className="flex-1 p-6">
                <div className="grid grid-cols-[1fr_280px] gap-6 h-[calc(100vh-100px)]">
                    {/* Feed Area */}
                    <div className="flex flex-col">
                        {/* Team Header */}
                        <div className="mb-4 flex items-center justify-between">
                            <h2 className="text-2xl font-black text-white flex items-center gap-2">
                                <span>{selectedTeam?.icon || 'üìã'}</span>
                                <span>{selectedTeam?.name || 'Combined View'}</span>
                            </h2>
                            <div className="text-xs font-bold text-slate-500 uppercase tracking-widest">
                                {selectedTeamId === 'all' ? 'Unified View' : 'Team Channel'}
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto space-y-3 pb-4">
                            {messages.length === 0 && (
                                <div className="text-slate-500 text-center py-10">
                                    „É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì
                                </div>
                            )}
                            {messages.map(msg => (
                                <div key={msg.id} className="bg-[#1F1E1D] rounded-xl p-4 border border-slate-700 hover:border-indigo-500/50 transition-colors relative">
                                    <div className={`absolute left-0 top-0 bottom-0 w-1 ${msg.status === 'done' ? 'bg-green-500' : 'bg-indigo-600'} rounded-l-xl`}></div>
                                    <div className="flex items-start gap-3 mb-3 pl-2">
                                        <div className="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white text-sm font-bold">
                                            {/* msg.user_id ? ... : 'U' - simplifying for now */}
                                            U
                                        </div>
                                        <div className="flex-1">
                                            <div className="font-bold text-white">User</div>
                                            <div className="text-xs text-slate-400">{new Date(msg.created_at).toLocaleString('ja-JP')}</div>
                                        </div>
                                    </div>
                                    <div className="text-slate-300 text-sm pl-2 whitespace-pre-wrap">
                                        {msg.content}
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* Post Form */}
                        <div className="bg-[#1F1E1D] rounded-xl p-4 border border-slate-700 mt-4 relative">
                            {showMentionList && (
                                <div className="absolute bottom-full left-0 mb-2 bg-[#2B2D31] border border-slate-700 rounded-lg shadow-xl w-64 max-h-48 overflow-y-auto z-50">
                                    {MOCK_USERS.filter(u => u.name.toLowerCase().includes(mentionQuery.toLowerCase()) || u.display.toLowerCase().includes(mentionQuery.toLowerCase())).map(user => (
                                        <button
                                            key={user.id}
                                            className="w-full text-left px-4 py-2 text-slate-300 hover:bg-indigo-600 hover:text-white transition-colors flex items-center gap-2"
                                            onClick={() => insertMention(user.name)}
                                        >
                                            <div className="w-6 h-6 rounded-full bg-slate-600 flex items-center justify-center text-xs">
                                                {user.display[0]}
                                            </div>
                                            <span className="text-sm font-medium">{user.display}</span>
                                            <span className="text-xs text-slate-500 ml-auto">@{user.name}</span>
                                        </button>
                                    ))}
                                </div>
                            )}

                            <div className="flex gap-2 mb-3">
                                <input
                                    type="text"
                                    className="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="‰ª∂Âêç..."
                                />
                                <button className="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                                    </svg>
                                </button>
                            </div>
                            <div className="flex gap-2">
                                <input
                                    ref={inputRef}
                                    type="text"
                                    value={postContent}
                                    onChange={handleInputChange}
                                    onKeyPress={(e) => e.key === 'Enter' && !e.shiftKey && handlePost()}
                                    className="flex-1 bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="ÂÜÖÂÆπ... @„É°„É≥„Ç∑„Éß„É≥"
                                />
                                <button
                                    onClick={handlePost}
                                    className="w-10 h-10 bg-indigo-600 hover:bg-indigo-700 rounded-full flex items-center justify-center transition-colors"
                                >
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Side Panel */}
                    <div className="space-y-4 overflow-y-auto">
                        <div>
                            <h3 className="text-xs font-black uppercase tracking-wider text-indigo-400 mb-3">Not Finished</h3>
                            <div className="space-y-2">
                                <div className="bg-[#1F1E1D] rounded-lg p-3 border border-slate-700 hover:border-indigo-500/50 transition-colors">
                                    <div className="text-white text-sm mb-1">Êú™ÂÆå‰∫Ü„ÅÆ„Çø„Çπ„ÇØ1</div>
                                    <div className="text-xs text-slate-400">2026/02/02</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 className="text-xs font-black uppercase tracking-wider text-indigo-400 mb-3">Mentions</h3>
                            <div className="space-y-2">
                                <div className="bg-[#1F1E1D] rounded-lg p-3 border border-slate-700 hover:border-indigo-500/50 transition-colors">
                                    <div className="text-white text-sm mb-1">@„ÅÇ„Å™„ÅüÂÆõ„Å¶„ÅÆ„É°„É≥„Ç∑„Éß„É≥</div>
                                    <div className="text-xs text-slate-400">2026/02/01</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div >
        </div >
    );
}
